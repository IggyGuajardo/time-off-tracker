<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Off Tracker</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #7fc8ed 0%, #5ba3d0 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #7fc8ed 0%, #5ba3d0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header img {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        .content {
            padding: 30px;
        }

        .login-form, .dashboard {
            display: none;
        }

        .login-form.active, .dashboard.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #7fc8ed;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: linear-gradient(135deg, #7fc8ed 0%, #5ba3d0 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(127, 200, 237, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-approve {
            background: #28a745;
            padding: 8px 15px;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-deny {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 14px;
        }

        .balance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: linear-gradient(135deg, #7fc8ed 0%, #5ba3d0 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .balance-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .balance-card .days {
            font-size: 48px;
            font-weight: bold;
        }

        .balance-card .label {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .request-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        .request-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .request-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .request-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #7fc8ed;
            padding-bottom: 10px;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .logout-btn {
            float: right;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #7fc8ed;
        }

        .stat-card .label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .employee-name {
            font-weight: 600;
            color: #5ba3d0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .balance-cards {
                grid-template-columns: 1fr;
            }

            .request-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
            }

            .request-table thead {
                display: none;
            }

            .request-table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                padding: 10px;
            }

            .request-table td {
                display: block;
                text-align: right;
                padding: 8px;
                border-bottom: 1px solid #f0f0f0;
                position: relative;
                padding-left: 50%;
            }

            .request-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                font-weight: 600;
                text-align: left;
            }

            .request-table td:last-child {
                border-bottom: none;
            }

            button {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
                margin: 5px 0;
            }

            .btn-secondary {
                margin-left: 0;
            }

            .logout-btn {
                float: none;
                display: block;
                margin-bottom: 10px;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .btn-approve, .btn-deny {
                width: 48%;
                display: inline-block;
                margin: 2px 1%;
            }
        }

        .hidden {
            display: none;
        }

        /* Calendar Styles */
        .calendar-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .calendar-day {
            min-height: 80px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 5px;
            position: relative;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            opacity: 0.5;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .calendar-event {
            background: #7fc8ed;
            color: white;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-event.sick {
            background: #ff9999;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #7fc8ed 0%, #5ba3d0 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .edit-btn {
            background: #ffc107;
            padding: 8px 15px;
            font-size: 14px;
            margin-right: 5px;
        }

        .cancel-edit-btn {
            background: #6c757d;
            padding: 8px 15px;
            font-size: 14px;
        }

        .denial-reason {
            margin-top: 10px;
        }

        .denial-reason textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 12px;
            min-height: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 3em; margin-bottom: 5px; letter-spacing: 2px;">REEMO</h1>
            <h2 style="font-size: 1.5em; margin-bottom: 10px; font-weight: 400;">Time Off Tracker</h2>
            <p>Manage Vacation and Sick Leave</p>
        </div>
        
        <div class="content">
            <!-- Login Form -->
            <div id="loginForm" class="login-form active">
                <h2 style="margin-bottom: 20px; color: #333;">Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button onclick="login()">Login</button>
                <button class="btn-secondary" onclick="showRegisterForm()">New Employee? Register</button>
                <div style="margin-top: 15px; text-align: center;">
                    <a href="#" onclick="showForgotPasswordForm(); return false;" style="color: #5ba3d0; text-decoration: none; font-weight: 600;">Forgot Password?</a>
                </div>
            </div>

            <!-- Registration Form -->
            <div id="registerForm" class="login-form">
                <h2 style="margin-bottom: 20px; color: #333;">Employee Registration</h2>
                <div class="form-group">
                    <label for="regName">Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="regAccountType">Account Type</label>
                    <select id="regAccountType" required onchange="toggleAdminWarning()">
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="adminWarning" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                    <strong>⚠️ Admin Registration:</strong> Only authorized email addresses can register as admin.
                </div>
                <div class="form-group" id="employeeFields">
                    <label for="regLocation">Location ID</label>
                    <input type="text" id="regLocation" placeholder="Enter your location ID" required>
                </div>
                <div class="form-group" id="employeeFields2">
                    <label for="regEmploymentType">Employment Type</label>
                    <select id="regEmploymentType" required>
                        <option value="">Select type</option>
                        <option value="fulltime">Full-Time</option>
                        <option value="parttime">Part-Time</option>
                    </select>
                </div>
                <div class="form-group" id="employeeFields3">
                    <label for="regHireDate">Hire Date</label>
                    <input type="date" id="regHireDate" required>
                </div>
                <button onclick="register()">Register</button>
                <button class="btn-secondary" onclick="showLoginForm()">Back to Login</button>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="login-form">
                <h2 style="margin-bottom: 20px; color: #333;">Reset Password</h2>
                <p style="margin-bottom: 20px; color: #666;">Enter your email address and we'll help you reset your password.</p>
                <div class="form-group">
                    <label for="forgotEmail">Email</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
                </div>
                <button onclick="resetPassword()">Reset Password</button>
                <button class="btn-secondary" onclick="showLoginForm()">Back to Login</button>
            </div>

            <!-- Employee Dashboard -->
            <div id="employeeDashboard" class="dashboard">
                <div class="user-info">
                    <button class="logout-btn btn-secondary" onclick="logout()">Logout</button>
                    <h3 id="employeeName">Welcome</h3>
                    <p id="employeeDetails"></p>
                </div>

                <div class="balance-cards">
                    <div class="balance-card">
                        <h3>Vacation Balance</h3>
                        <div class="days" id="vacationDays">0</div>
                        <div class="label">days remaining</div>
                    </div>
                    <div class="balance-card">
                        <h3>Sick Leave Balance</h3>
                        <div class="days" id="sickDays">0</div>
                        <div class="label">days remaining</div>
                    </div>
                </div>

                <div class="section">
                    <h2>Request Time Off</h2>
                    <div class="form-group">
                        <label for="requestStartDate">Start Date</label>
                        <input type="date" id="requestStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="requestEndDate">End Date</label>
                        <input type="date" id="requestEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="requestType">Type</label>
                        <select id="requestType" required>
                            <option value="">Select type</option>
                            <option value="vacation">Vacation</option>
                            <option value="sick">Sick Leave</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="requestNotes">Notes</label>
                        <textarea id="requestNotes" placeholder="Optional notes about your request"></textarea>
                    </div>
                    <button onclick="submitRequest()">Submit Request</button>
                </div>

                <div class="section">
                    <h2>My Requests</h2>
                    <table class="request-table" id="employeeRequestsTable">
                        <thead>
                            <tr>
                                <th>Dates</th>
                                <th>Type</th>
                                <th>Days</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeRequestsBody">
                            <tr><td colspan="6" style="text-align: center; padding: 40px;">No requests yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="dashboard">
                <div class="user-info">
                    <button class="logout-btn btn-secondary" onclick="logout()">Logout</button>
                    <h3>Admin Dashboard</h3>
                    <p>Manage all time-off requests</p>
                </div>

                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="number" id="totalEmployees">0</div>
                        <div class="label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="pendingRequests">0</div>
                        <div class="label">Pending Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="approvedToday">0</div>
                        <div class="label">Approved Today</div>
                    </div>
                </div>

                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('requests')">All Requests</button>
                    <button class="tab-btn" onclick="switchTab('calendar')">Calendar View</button>
                </div>

                <div id="requestsTab" class="tab-content active">
                    <div class="section">
                        <h2>All Time Off Requests</h2>
                        <table class="request-table" id="adminRequestsTable">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Location</th>
                                    <th>Dates</th>
                                    <th>Type</th>
                                    <th>Days</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="adminRequestsBody">
                                <tr><td colspan="8" style="text-align: center; padding: 40px;">No requests yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="calendarTab" class="tab-content">
                    <div class="section">
                        <h2>Time Off Calendar</h2>
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button onclick="previousMonth()">&larr; Previous</button>
                                <h3 id="calendarMonthYear"></h3>
                                <button onclick="nextMonth()">Next &rarr;</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EMAILJS CONFIGURATION
        const EMAILJS_SERVICE_ID = 'service_6ktvivl';
        const EMAILJS_ADMIN_TEMPLATE_ID = 'template_wfr56w9';
        const EMAILJS_EMPLOYEE_TEMPLATE_ID = 'template_0ebpplc';
        const EMAILJS_PUBLIC_KEY = '1zB3G21AGc-BegH1l';

        // Initialize EmailJS
        (function() {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        })();

        // AUTHORIZED ADMIN EMAILS - Only these emails can register as admin
        const AUTHORIZED_ADMIN_EMAILS = [
            'admin@reemo.com',
            'hr@reemo.com',
            'manager@reemo.com'
            // Add more authorized admin emails here
        ];

        // Initialize data structure
        let currentUser = null;
        let currentCalendarDate = new Date();
        let editingRequestId = null;
        
        // Load data from localStorage or initialize
        let users = JSON.parse(localStorage.getItem('timeOffUsers')) || [
            {
                id: 1,
                name: 'Admin User',
                email: 'admin@company.com',
                password: 'admin123',
                role: 'admin',
                locationId: 'HQ-001',
                employmentType: 'fulltime',
                hireDate: '2020-01-01',
                vacationDays: 0,
                sickDays: 0
            },
            {
                id: 2,
                name: 'John Doe',
                email: 'john@company.com',
                password: 'john123',
                role: 'employee',
                locationId: 'LOC-001',
                employmentType: 'fulltime',
                hireDate: '2023-03-15',
                vacationDays: 5,
                sickDays: 5
            }
        ];

        let requests = JSON.parse(localStorage.getItem('timeOffRequests')) || [
            {
                id: 1,
                userId: 2,
                startDate: '2025-11-15',
                endDate: '2025-11-15',
                type: 'vacation',
                days: 1,
                status: 'pending',
                notes: 'Family vacation',
                submittedDate: '2025-10-28',
                denialReason: null
            }
        ];

        // Format date from YYYY-MM-DD to MM/DD/YYYY
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        // Send email notification to admin when employee submits request
        async function sendAdminNotification(employeeName, employeeEmail, employeeLocation, requestDetails) {
            try {
                const templateParams = {
                    employee_name: employeeName,
                    employee_email: employeeEmail,
                    employee_location: employeeLocation,
                    request_type: requestDetails.type === 'vacation' ? 'Vacation' : 'Sick Leave',
                    start_date: formatDate(requestDetails.startDate),
                    end_date: formatDate(requestDetails.endDate),
                    days_requested: requestDetails.days,
                    request_notes: requestDetails.notes || 'None',
                    admin_email: 'iggy.reemo@gmail.com'
                };

                const response = await emailjs.send(
                    EMAILJS_SERVICE_ID,
                    EMAILJS_ADMIN_TEMPLATE_ID,
                    templateParams
                );
                
                console.log('Admin email sent successfully:', response);
                return true;
            } catch (error) {
                console.error('Error sending admin notification:', error);
                return false;
            }
        }

        // Send email notification to employee when request is approved/denied
        async function sendEmployeeNotification(employeeEmail, employeeName, requestDetails, status, customMessage = null) {
            try {
                const statusText = status === 'approved' ? 'APPROVED' : 'DENIED';
                const statusMessage = customMessage || (status === 'approved' 
                    ? 'Enjoy your time off!' 
                    : 'Please contact your manager for more information.');

                const templateParams = {
                    employee_email: employeeEmail,
                    employee_name: employeeName,
                    request_type: requestDetails.type === 'vacation' ? 'Vacation' : 'Sick Leave',
                    start_date: formatDate(requestDetails.startDate),
                    end_date: formatDate(requestDetails.endDate),
                    days_requested: requestDetails.days,
                    status_text: statusText,
                    status_message: statusMessage
                };

                const response = await emailjs.send(
                    EMAILJS_SERVICE_ID,
                    EMAILJS_EMPLOYEE_TEMPLATE_ID,
                    templateParams
                );
                
                console.log('Employee email sent successfully:', response);
                return true;
            } catch (error) {
                console.error('Error sending employee notification:', error);
                return false;
            }
        }

        // Send confirmation email to employee when they submit request
        async function sendEmployeeConfirmation(employeeEmail, employeeName, requestDetails) {
            try {
                console.log('Attempting to send employee confirmation to:', employeeEmail);
                
                const templateParams = {
                    employee_email: employeeEmail,
                    employee_name: employeeName,
                    request_type: requestDetails.type === 'vacation' ? 'Vacation' : 'Sick Leave',
                    start_date: formatDate(requestDetails.startDate),
                    end_date: formatDate(requestDetails.endDate),
                    days_requested: requestDetails.days,
                    status_text: 'SUBMITTED',
                    status_message: 'Your request has been submitted and is pending approval. You will receive another email once your request has been reviewed.'
                };

                console.log('Template params:', templateParams);

                const response = await emailjs.send(
                    EMAILJS_SERVICE_ID,
                    EMAILJS_EMPLOYEE_TEMPLATE_ID,
                    templateParams
                );
                
                console.log('Employee confirmation email sent successfully:', response);
                return true;
            } catch (error) {
                console.error('Error sending employee confirmation:', error);
                console.error('Error details:', error.text || error.message);
                return false;
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('timeOffUsers', JSON.stringify(users));
            localStorage.setItem('timeOffRequests', JSON.stringify(requests));
        }

        // Calculate accrued days based on hire date
        function calculateAccruedDays(hireDate) {
            const hire = new Date(hireDate);
            const now = new Date();
            const currentYear = now.getFullYear();
            const yearStart = new Date(currentYear, 0, 1); // January 1st of current year
            
            // Everyone resets on January 1st
            let startDate;
            
            // If hired this year, start counting from hire date
            // If hired before this year, start counting from January 1st
            if (hire.getFullYear() === currentYear) {
                startDate = hire;
            } else {
                startDate = yearStart;
            }
            
            // Calculate COMPLETE months from start date to now
            // Days only accrue at the END of each month
            let monthsCompleted = 0;
            
            let tempDate = new Date(startDate);
            
            // Move to the end of the hire/start month
            let checkDate = new Date(tempDate.getFullYear(), tempDate.getMonth() + 1, 0); // Last day of start month
            
            while (checkDate < now) {
                monthsCompleted++;
                // Move to end of next month
                checkDate = new Date(checkDate.getFullYear(), checkDate.getMonth() + 2, 0);
            }
            
            // Each completed month earns 1 vacation day and 1 sick day
            // Maximum is 5 days per year (earned by end of May)
            const vacationDays = Math.min(monthsCompleted, 5);
            const sickDays = Math.min(monthsCompleted, 5);
            
            return { vacationDays, sickDays };
        }

        // Update all employees' accrued days
        function updateAllAccruedDays() {
            users.forEach(user => {
                if (user.role === 'employee') {
                    const { vacationDays, sickDays } = calculateAccruedDays(user.hireDate);
                    
                    // Calculate used days
                    const approvedRequests = requests.filter(r => 
                        r.userId === user.id && r.status === 'approved'
                    );
                    
                    const usedVacation = approvedRequests
                        .filter(r => r.type === 'vacation')
                        .reduce((sum, r) => sum + r.days, 0);
                    
                    const usedSick = approvedRequests
                        .filter(r => r.type === 'sick')
                        .reduce((sum, r) => sum + r.days, 0);
                    
                    // Update available days
                    user.vacationDays = Math.max(0, vacationDays - usedVacation);
                    user.sickDays = Math.max(0, sickDays - usedSick);
                }
            });
            saveData();
        }

        // Login
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                updateAllAccruedDays();
                
                if (user.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showEmployeeDashboard();
                }
            } else {
                alert('Invalid email or password');
            }
        }

        // Register
        function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const accountType = document.getElementById('regAccountType').value;
            
            if (!name || !email || !password || !accountType) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if email already exists
            if (users.find(u => u.email === email)) {
                alert('Email already registered');
                return;
            }
            
            let newUser;
            
            if (accountType === 'admin') {
                // Validate admin email
                if (!AUTHORIZED_ADMIN_EMAILS.includes(email.toLowerCase())) {
                    alert('⚠️ Unauthorized Admin Email\n\nThis email address is not authorized to register as an admin. Please contact your system administrator or register as an employee.');
                    return;
                }
                
                // Create admin user
                newUser = {
                    id: users.length + 1,
                    name,
                    email,
                    password,
                    role: 'admin',
                    locationId: 'HQ-ADMIN',
                    employmentType: 'fulltime',
                    hireDate: new Date().toISOString().split('T')[0],
                    vacationDays: 0,
                    sickDays: 0
                };
            } else {
                // Employee registration - require all fields
                const locationId = document.getElementById('regLocation').value;
                const employmentType = document.getElementById('regEmploymentType').value;
                const hireDate = document.getElementById('regHireDate').value;
                
                if (!locationId || !employmentType || !hireDate) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const { vacationDays, sickDays } = calculateAccruedDays(hireDate);
                
                newUser = {
                    id: users.length + 1,
                    name,
                    email,
                    password,
                    role: 'employee',
                    locationId,
                    employmentType,
                    hireDate,
                    vacationDays,
                    sickDays
                };
            }
            
            users.push(newUser);
            saveData();
            
            alert('Registration successful! You can now login.');
            showLoginForm();
        }

        // Toggle admin warning message
        function toggleAdminWarning() {
            const accountType = document.getElementById('regAccountType').value;
            const adminWarning = document.getElementById('adminWarning');
            const employeeFields = document.getElementById('employeeFields');
            const employeeFields2 = document.getElementById('employeeFields2');
            const employeeFields3 = document.getElementById('employeeFields3');
            
            if (accountType === 'admin') {
                adminWarning.style.display = 'block';
                employeeFields.style.display = 'none';
                employeeFields2.style.display = 'none';
                employeeFields3.style.display = 'none';
                // Make employee fields not required for admin
                document.getElementById('regLocation').required = false;
                document.getElementById('regEmploymentType').required = false;
                document.getElementById('regHireDate').required = false;
            } else {
                adminWarning.style.display = 'none';
                employeeFields.style.display = 'block';
                employeeFields2.style.display = 'block';
                employeeFields3.style.display = 'block';
                // Make employee fields required
                document.getElementById('regLocation').required = true;
                document.getElementById('regEmploymentType').required = true;
                document.getElementById('regHireDate').required = true;
            }
        }

        // Reset Password
        function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Find user by email
            const user = users.find(u => u.email === email);
            
            if (!user) {
                alert('No account found with that email address');
                return;
            }
            
            // Update password
            user.password = newPassword;
            saveData();
            
            // Clear form
            document.getElementById('forgotEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            alert('Password reset successful! You can now login with your new password.');
            showLoginForm();
        }

        // Show forgot password form
        function showForgotPasswordForm() {
            hideAllViews();
            document.getElementById('forgotPasswordForm').classList.add('active');
        }

        // Submit time off request
        async function submitRequest() {
            const startDate = document.getElementById('requestStartDate').value;
            const endDate = document.getElementById('requestEndDate').value;
            const type = document.getElementById('requestType').value;
            const notes = document.getElementById('requestNotes').value;
            
            if (!startDate || !endDate || !type) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate end date is not before start date
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date cannot be before start date');
                return;
            }
            
            // Calculate number of days (inclusive)
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end dates
            
            // Check if user has enough days
            if (type === 'vacation' && days > currentUser.vacationDays) {
                alert(`Insufficient vacation days. You have ${currentUser.vacationDays} days available.`);
                return;
            }
            
            if (type === 'sick' && days > currentUser.sickDays) {
                alert(`Insufficient sick leave days. You have ${currentUser.sickDays} days available.`);
                return;
            }
            
            const newRequest = {
                id: requests.length + 1,
                userId: currentUser.id,
                startDate,
                endDate,
                type,
                days,
                status: 'pending',
                notes,
                submittedDate: new Date().toISOString().split('T')[0]
            };
            
            requests.push(newRequest);
            saveData();
            
            console.log('About to send admin notification...');
            // Send email notification to admin
            await sendAdminNotification(currentUser.name, currentUser.email, currentUser.locationId, newRequest);
            
            console.log('About to send employee confirmation...');
            console.log('Current user email:', currentUser.email);
            // Send confirmation email to employee
            const employeeEmailSent = await sendEmployeeConfirmation(currentUser.email, currentUser.name, newRequest);
            console.log('Employee email sent result:', employeeEmailSent);
            
            // Clear form
            document.getElementById('requestStartDate').value = '';
            document.getElementById('requestEndDate').value = '';
            document.getElementById('requestType').value = '';
            document.getElementById('requestNotes').value = '';
            
            alert('Request submitted successfully! You and the admin have been notified via email.');
            showEmployeeDashboard();
        }

        // Approve request
        async function approveRequest(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (request) {
                request.status = 'approved';
                
                // Deduct days from user
                const user = users.find(u => u.id === request.userId);
                if (request.type === 'vacation') {
                    user.vacationDays -= request.days;
                } else {
                    user.sickDays -= request.days;
                }
                
                saveData();
                
                // Send email notification to employee
                await sendEmployeeNotification(user.email, user.name, request, 'approved');
                
                alert('Request approved! Employee has been notified via email.');
                showAdminDashboard();
            }
        }

        // Deny request
        async function denyRequest(requestId, denialReason) {
            const request = requests.find(r => r.id === requestId);
            if (request) {
                request.status = 'denied';
                request.denialReason = denialReason || null;
                saveData();
                
                // Send email notification to employee with denial reason
                const user = users.find(u => u.id === request.userId);
                
                // Add denial reason to status message if provided
                const statusMessage = denialReason 
                    ? `Reason for denial: ${denialReason}\n\nPlease contact your manager if you have questions.`
                    : 'Please contact your manager for more information.';
                
                // Create a modified request object for email
                const emailRequest = {
                    ...request,
                    statusMessage: statusMessage
                };
                
                await sendEmployeeNotification(user.email, user.name, emailRequest, 'denied', statusMessage);
                
                alert('Request denied. Employee has been notified via email.');
                showAdminDashboard();
            }
        }

        // Show employee dashboard
        function showEmployeeDashboard() {
            hideAllViews();
            document.getElementById('employeeDashboard').classList.add('active');
            
            // Reset edit mode
            cancelEdit();
            
            // Update employee info
            document.getElementById('employeeName').textContent = `Welcome, ${currentUser.name}`;
            document.getElementById('employeeDetails').textContent = 
                `Location: ${currentUser.locationId} | ${currentUser.employmentType === 'fulltime' ? 'Full-Time' : 'Part-Time'} | Hired: ${formatDate(currentUser.hireDate)}`;
            
            // Update balance - show only days
            document.getElementById('vacationDays').textContent = currentUser.vacationDays;
            document.getElementById('sickDays').textContent = currentUser.sickDays;
            
            // Load user's requests
            const userRequests = requests.filter(r => r.userId === currentUser.id);
            const tbody = document.getElementById('employeeRequestsBody');
            
            if (userRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No requests yet</td></tr>';
            } else {
                tbody.innerHTML = userRequests.map(r => {
                    const dateRange = r.startDate === r.endDate 
                        ? formatDate(r.startDate)
                        : `${formatDate(r.startDate)} to ${formatDate(r.endDate)}`;
                    
                    const actionButtons = r.status === 'pending' 
                        ? `<button class="edit-btn" onclick="editRequest(${r.id})">Edit</button>
                           <button class="btn-deny" onclick="deleteRequest(${r.id})">Delete</button>`
                        : '-';
                    
                    const notesDisplay = r.status === 'denied' && r.denialReason
                        ? `${r.notes || '-'}<br><strong>Denial Reason:</strong> ${r.denialReason}`
                        : r.notes || '-';
                    
                    return `
                        <tr>
                            <td data-label="Dates">${dateRange}</td>
                            <td data-label="Type">${r.type === 'vacation' ? 'Vacation' : 'Sick Leave'}</td>
                            <td data-label="Days">${r.days}</td>
                            <td data-label="Status"><span class="status status-${r.status}">${r.status.toUpperCase()}</span></td>
                            <td data-label="Notes">${notesDisplay}</td>
                            <td data-label="Actions">${actionButtons}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Show admin dashboard
        function showAdminDashboard() {
            hideAllViews();
            document.getElementById('adminDashboard').classList.add('active');
            
            // Update stats
            const employees = users.filter(u => u.role === 'employee');
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('pendingRequests').textContent = 
                requests.filter(r => r.status === 'pending').length;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('approvedToday').textContent = 
                requests.filter(r => r.status === 'approved' && r.submittedDate === today).length;
            
            // Load all requests
            const tbody = document.getElementById('adminRequestsBody');
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No requests yet</td></tr>';
            } else {
                tbody.innerHTML = requests.map(r => {
                    const user = users.find(u => u.id === r.userId);
                    const dateRange = r.startDate === r.endDate 
                        ? formatDate(r.startDate)
                        : `${formatDate(r.startDate)} to ${formatDate(r.endDate)}`;
                    
                    const notesDisplay = r.denialReason 
                        ? `${r.notes || '-'}<br><strong>Denial:</strong> ${r.denialReason}`
                        : r.notes || '-';
                    
                    return `
                        <tr>
                            <td data-label="Employee"><span class="employee-name">${user.name}</span></td>
                            <td data-label="Location">${user.locationId}</td>
                            <td data-label="Dates">${dateRange}</td>
                            <td data-label="Type">${r.type === 'vacation' ? 'Vacation' : 'Sick Leave'}</td>
                            <td data-label="Days">${r.days}</td>
                            <td data-label="Status"><span class="status status-${r.status}">${r.status.toUpperCase()}</span></td>
                            <td data-label="Notes">${notesDisplay}</td>
                            <td data-label="Action">
                                ${r.status === 'pending' ? `
                                    <button class="btn-approve" onclick="approveRequest(${r.id})">Approve</button>
                                    <button class="btn-deny" onclick="showDenyDialog(${r.id})">Deny</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Show denial dialog
        function showDenyDialog(requestId) {
            const reason = prompt('Please enter reason for denial (optional):');
            if (reason !== null) { // User clicked OK (even if empty)
                denyRequest(requestId, reason);
            }
        }

        // Navigation functions
        function showLoginForm() {
            hideAllViews();
            document.getElementById('loginForm').classList.add('active');
        }

        function showRegisterForm() {
            hideAllViews();
            document.getElementById('registerForm').classList.add('active');
        }

        function hideAllViews() {
            document.querySelectorAll('.login-form, .dashboard').forEach(el => {
                el.classList.remove('active');
            });
        }

        function logout() {
            currentUser = null;
            showLoginForm();
        }

        // Initialize on page load
        updateAllAccruedDays();

        // Tab switching for admin
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'requests') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('requestsTab').classList.add('active');
            } else if (tabName === 'calendar') {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('calendarTab').classList.add('active');
                renderCalendar();
            }
        }

        // Calendar functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            let html = '';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${daysInPrevMonth - i}</div>
                </div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = getEventsForDate(dateStr);
                
                html += `<div class="calendar-day">
                    <div class="calendar-day-number">${day}</div>`;
                
                events.forEach(event => {
                    const eventClass = event.type === 'vacation' ? '' : 'sick';
                    html += `<div class="calendar-event ${eventClass}" title="${event.name} - ${event.type}">${event.name}</div>`;
                });
                
                html += `</div>`;
            }
            
            // Next month days to fill grid
            const totalCells = html.split('calendar-day').length - 1;
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function getEventsForDate(dateStr) {
            const events = [];
            const targetDate = new Date(dateStr + 'T00:00:00');
            
            requests.forEach(request => {
                if (request.status === 'approved') {
                    const startDate = new Date(request.startDate + 'T00:00:00');
                    const endDate = new Date(request.endDate + 'T00:00:00');
                    
                    if (targetDate >= startDate && targetDate <= endDate) {
                        const user = users.find(u => u.id === request.userId);
                        if (user) {
                            events.push({
                                name: user.name,
                                type: request.type
                            });
                        }
                    }
                }
            });
            
            return events;
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // Edit request functions
        function editRequest(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Only pending requests can be edited');
                return;
            }
            
            editingRequestId = requestId;
            document.getElementById('requestStartDate').value = request.startDate;
            document.getElementById('requestEndDate').value = request.endDate;
            document.getElementById('requestType').value = request.type;
            document.getElementById('requestNotes').value = request.notes || '';
            
            // Scroll to form
            document.querySelector('.section h2').scrollIntoView({ behavior: 'smooth' });
            
            // Update button text
            const submitBtn = document.querySelector('button[onclick="submitRequest()"]');
            submitBtn.textContent = 'Update Request';
            submitBtn.onclick = updateRequest;
        }

        function cancelEdit() {
            editingRequestId = null;
            document.getElementById('requestStartDate').value = '';
            document.getElementById('requestEndDate').value = '';
            document.getElementById('requestType').value = '';
            document.getElementById('requestNotes').value = '';
            
            const submitBtn = document.querySelector('.section button');
            submitBtn.textContent = 'Submit Request';
            submitBtn.onclick = submitRequest;
        }

        async function updateRequest() {
            const request = requests.find(r => r.id === editingRequestId);
            if (!request) return;
            
            const startDate = document.getElementById('requestStartDate').value;
            const endDate = document.getElementById('requestEndDate').value;
            const type = document.getElementById('requestType').value;
            const notes = document.getElementById('requestNotes').value;
            
            if (!startDate || !endDate || !type) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date cannot be before start date');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            if (type === 'vacation' && days > currentUser.vacationDays) {
                alert(`Insufficient vacation days. You have ${currentUser.vacationDays} days available.`);
                return;
            }
            
            if (type === 'sick' && days > currentUser.sickDays) {
                alert(`Insufficient sick leave days. You have ${currentUser.sickDays} days available.`);
                return;
            }
            
            // Update request
            request.startDate = startDate;
            request.endDate = endDate;
            request.type = type;
            request.days = days;
            request.notes = notes;
            
            saveData();
            cancelEdit();
            alert('Request updated successfully!');
            showEmployeeDashboard();
        }

        function deleteRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request?')) return;
            
            const index = requests.findIndex(r => r.id === requestId);
            if (index !== -1) {
                requests.splice(index, 1);
                saveData();
                showEmployeeDashboard();
            }
        }

        // Check for pending requests that need reminders (call this periodically)
        function checkPendingReminders() {
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];
            
            const oldPendingRequests = requests.filter(r => 
                r.status === 'pending' && r.submittedDate <= twoDaysAgoStr
            );
            
            // In a real app, this would send reminder emails
            // For now, just log
            if (oldPendingRequests.length > 0) {
                console.log(`${oldPendingRequests.length} pending requests need attention`);
            }
        }
    </script>
</body>
</html>



